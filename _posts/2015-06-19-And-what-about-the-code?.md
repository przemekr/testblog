---
layout: post
title: And what about the code?
date: 2015-06-19 12:28:02
---

This posts are generated by sending en email to a mail server. The server has setup a `.forward` file with will invoke a shell script when email is receivced:

{% highlight bash linenos %}
\przemekr
|/arpa/p/przemekr/mail_to_jekyll.sh
{% endhighlight %}

The first line means the email should be delivered to the normal INBOX. The
second one starts the script with the email as stdin. The script is quite
simple, just go through the email headers to find the subject and check which
repository should be updated.

It look something like:

{% highlight bash linenos %}

H=/arpa/p/przemekr
D=$H/jekyll_tmp 
cd $D && rm *

log()
{
   echo $1 >> log
}

hendleContent()
{
   log "REPO: $REPO"
   log "TITLE: $TITLE"
   TITLENS=$(echo $TITLE | sed 's/ /-/g')
   FILE=$H/$REPO/_posts/$(date +%Y-%m-%d)-$TITLENS.md
   log "FILE: $FILE"

   echo "---" > $FILE
   echo "layout: post" >> $FILE
   echo "title: $TITLE" >> $FILE
   echo "date: $(date '+%Y-%m-%d %H:%M:%S')" >> $FILE
   echo "---" >> $FILE
   echo "" >> $FILE

   while IFS= read -r LINE; do
      echo "$LINE" >> mail
      echo "$LINE" >> content
   done

   munpack -t mail > unpack

   text=$(grep text/plain unpack | cut -d' ' -f1)
   log "text:$text"
   if [ "$text" != "" ]; then
      cat $text >> $FILE
   else
      cat content >> $FILE
   fi
   files_to_add=$FILE

   images=$(grep image unpack | cut -d' ' -f1)
   log "images:$images"
   for i in $images; do
      target=$H/$REPO/assets/$i
      convert $i -resize 1024x1024\> -auto-orient s-$i
      cp s-$i $target
      log "cp:s-$i $target"
      files_to_add="$files_to_add $target"
      echo "" >> $FILE
      echo "![$i]({{ site.baseurl }}/assets/$i)" >> $FILE
   done

   cd $(dirname $FILE)
   git fetch && git reset origin/gh-pages
   git add $files_to_add
   git commit -m "updated with mail: $TITLE"
   git push origin HEAD:gh-pages
}

hendleSubject()
{
   case $1 in
      Jekyll)
         shift
         REPO=$1
         shift
         TITLE=$*
         ;;
      *)
         log "not Jekkyl exit...: $*"
         exit 0
         ;;
   esac
}

hendleHeader()
{
   k=$1
   v=$2
   log "$k $v"
   case $k in
      Subject)
         hendleSubject $v
         ;;
      *)
         ;;
   esac
}

read dumy FROM date
echo "From $FROM $date" >> mail

while IFS= read -r LINE; do
   echo "$LINE" >> mail
   case $LINE in
      "")
         hendleContent;;
      *)
         key=$(echo $LINE | cut -d: -f1)
         value=$(echo $LINE | cut -d: -f2-)
         hendleHeader "$key" "$value"
         ;;
   esac
done
exit 0
{% endhighlight %}
